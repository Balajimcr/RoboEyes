<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RoboEyes Auto</title>
    <style>
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background: black; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
            touch-action: none; 
        }
        canvas {
            max-width: 100%; max-height: 100%;
            object-fit: contain;
            image-rendering: pixelated; 
        }
        #ui-layer {
            position: absolute; bottom: 30px; left: 0; width: 100%;
            text-align: center; pointer-events: none;
            z-index: 10;
        }
        .status-text {
            color: #0f0; font-family: monospace; font-size: 18px;
            background: rgba(0,0,0,0.6); padding: 8px 20px;
            border-radius: 8px; border: 1px solid #0f0;
            letter-spacing: 1px;
        }
    </style>
</head>
<body>

    <canvas id="eyeCanvas"></canvas>
    
    <div id="ui-layer">
        <span class="status-text" id="label">LOADING...</span>
    </div>

    <script>
        // --- CONFIGURATION ---
        const GRID_ROWS = 7;
        const GRID_COLS = 7;
        const DELAY = 600;
        const ATLAS_PATH = 'assets/Eye_Expressions_HD.png';
        const CSV_PATH = 'assets/Expressions_Label.csv';

        // --- STATE ---
        const canvas = document.getElementById('eyeCanvas');
        const ctx = canvas.getContext('2d');
        const labelText = document.getElementById('label');

        let atlas = new Image();
        let csvData = [];
        let currentRow = 0;
        let currentCol = 0;
        let autoplay = true; // Enabled by default
        let timer = null;
        let isFirstTouch = true;

        let touchStartX = 0;
        const swipeThreshold = 50;

        // --- CORE LOGIC ---
        async function init() {
            try {
                const response = await fetch(CSV_PATH);
                if (!response.ok) throw new Error("CSV missing");
                const text = await response.text();
                csvData = text.split('\n').map(row => row.replace('\r', '').split(','));

                atlas.src = ATLAS_PATH;
                atlas.onload = () => {
                    drawFrame();
                    startLoop(); // Start animating immediately
                };
            } catch (err) {
                labelText.innerText = "Error Loading Assets";
            }
        }

        function drawFrame() {
            if (!atlas.complete || csvData.length === 0) return;
            const tileW = atlas.width / GRID_COLS;
            const tileH = atlas.height / GRID_ROWS;
            if (canvas.width !== tileW) {
                canvas.width = tileW;
                canvas.height = tileH;
            }
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(atlas, currentCol * tileW, currentRow * tileH, tileW, tileH, 0, 0, tileW, tileH);
            try {
                const state = csvData[currentRow + 1][currentCol + 1];
                labelText.innerText = state || "ROBO-EYES";
            } catch (e) { labelText.innerText = "ROBO-EYES"; }
        }

        function nextFrame() {
            currentCol++;
            if (currentCol >= GRID_COLS) {
                currentCol = 0;
                currentRow = (currentRow + 1) % GRID_ROWS;
            }
            drawFrame();
        }

        function prevFrame() {
            currentCol--;
            if (currentCol < 0) {
                currentCol = GRID_COLS - 1;
                currentRow = (currentRow > 0) ? currentRow - 1 : GRID_ROWS - 1;
            }
            drawFrame();
        }

        function startLoop() {
            if (timer) clearInterval(timer);
            timer = setInterval(() => { if (autoplay) nextFrame(); }, DELAY);
        }

        // --- INTERACTION ---
        window.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
            
            // First tap enables Fullscreen (required by browsers)
            if (isFirstTouch) {
                enterFullscreen();
                isFirstTouch = false;
            }
        }, false);

        window.addEventListener('touchend', (e) => {
            const touchEndX = e.changedTouches[0].screenX;
            const diff = touchStartX - touchEndX;

            if (Math.abs(diff) > swipeThreshold) {
                // Swipe detected: Move and stay paused for manual control
                autoplay = false; 
                if (diff > 0) nextFrame(); 
                else prevFrame();
            } else {
                // Tap detected: Manually cycle to next frame and pause auto
                autoplay = false;
                nextFrame();
            }
        }, false);

        function enterFullscreen() {
            const doc = document.documentElement;
            if (doc.requestFullscreen) doc.requestFullscreen();
            else if (doc.webkitRequestFullscreen) doc.webkitRequestFullscreen();
        }

        // Keyboard Support
        window.addEventListener('keydown', (e) => {
            autoplay = false;
            if (e.key === 'ArrowRight' || e.key === ' ') nextFrame();
            if (e.key === 'ArrowLeft') prevFrame();
        });

        init();
    </script>
</body>
</html>